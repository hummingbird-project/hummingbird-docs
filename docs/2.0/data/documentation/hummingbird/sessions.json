{"kind":"article","schemaVersion":{"minor":3,"major":0,"patch":0},"abstract":[{"text":"Session based authentication","type":"text"}],"hierarchy":{"paths":[["doc:\/\/com.opticalaberration.hummingbird\/documentation\/index"]]},"metadata":{"images":[{"type":"icon","identifier":"logo.png"}],"title":"Sessions","role":"article","roleHeading":"Article"},"seeAlsoSections":[{"title":"Related Documentation","anchor":"Related-Documentation","identifiers":["doc:\/\/com.opticalaberration.hummingbird\/documentation\/HummingbirdAuth\/SessionAuthenticator","doc:\/\/com.opticalaberration.hummingbird\/documentation\/HummingbirdAuth\/SessionRequestContext"]},{"generated":true,"identifiers":["doc:\/\/com.opticalaberration.hummingbird\/documentation\/Hummingbird\/AuthenticatorMiddlewareGuide","doc:\/\/com.opticalaberration.hummingbird\/documentation\/Hummingbird\/OneTimePasswords"],"title":"Authentication","anchor":"Authentication"}],"primaryContentSections":[{"content":[{"anchor":"overview","level":2,"type":"heading","text":"Overview"},{"type":"paragraph","inlineContent":[{"type":"text","text":"Sessions allow you to persist state eg user authentication status between multiple requests to the server. They work by creating a temporary session object that is stored in a key\/value store. The key or session id is returned in the response. Subsequent requests can then access the session object by supplying the session id in their request. This object can then be used to authenicate the user. Normally the session id is stored in a cookie."}]},{"level":2,"anchor":"SessionMiddleware","type":"heading","text":"SessionMiddleware"},{"inlineContent":[{"type":"text","text":"The "},{"type":"reference","identifier":"doc:\/\/com.opticalaberration.hummingbird\/documentation\/HummingbirdAuth\/SessionMiddleware","isActive":true},{"text":" is used to extract and save session state from the RequestContext. To use it, your ","type":"text"},{"code":"RequestContext","type":"codeVoice"},{"text":" must conform to ","type":"text"},{"type":"reference","identifier":"doc:\/\/com.opticalaberration.hummingbird\/documentation\/HummingbirdAuth\/SessionRequestContext","isActive":true},{"type":"text","text":". Adding the "},{"type":"codeVoice","code":"SessionMiddleware"},{"text":" to your middleware stack will mean any middleware or routes after will have read\/write access to session state via the member ","type":"text"},{"identifier":"doc:\/\/com.opticalaberration.hummingbird\/documentation\/HummingbirdAuth\/SessionRequestContext\/sessions","isActive":true,"type":"reference"},{"type":"text","text":"."}],"type":"paragraph"},{"inlineContent":[{"type":"text","text":"The "},{"type":"codeVoice","code":"SessionMiddleware"},{"text":" needs a persist key value store to save its state. You can find out more about the persist framework here ","type":"text"},{"isActive":true,"identifier":"doc:\/\/com.opticalaberration.hummingbird\/documentation\/Hummingbird\/PersistentData","type":"reference"},{"type":"text","text":". In the example below we are using an in memory key value store, but "},{"isActive":true,"type":"reference","identifier":"doc:\/\/com.opticalaberration.hummingbird\/documentation\/HummingbirdFluent\/FluentPersistDriver"},{"type":"text","text":" and "},{"identifier":"doc:\/\/com.opticalaberration.hummingbird\/documentation\/HummingbirdRedis\/RedisPersistDriver","type":"reference","isActive":true},{"text":" provide solutions that stores the session data in a database or redis database respectively.","type":"text"}],"type":"paragraph"},{"syntax":"swift","type":"codeListing","code":["router.add(","    middleware: SessionMiddleware(","        storage: MemoryPersistDriver()","    )",")"]},{"type":"paragraph","inlineContent":[{"text":"By default sessions store the session id in a ","type":"text"},{"code":"SESSION_ID","type":"codeVoice"},{"type":"text","text":" cookie and the default session expiration is 12 hours. At initialization it is possible to set these up differently."}]},{"syntax":"swift","code":["router.add(","    middleware: SessionMiddleware(","        storage: MemoryPersistDriver(),","        sessionCookie: \"MY_SESSION_ID\",","        defaultSessionExpiration: .seconds(60 * 60)","    )",")"],"type":"codeListing"},{"level":2,"text":"SessionRequestContext","type":"heading","anchor":"SessionRequestContext"},{"type":"paragraph","inlineContent":[{"type":"text","text":"The "},{"type":"reference","identifier":"doc:\/\/com.opticalaberration.hummingbird\/documentation\/HummingbirdAuth\/SessionRequestContext","isActive":true},{"text":" protocol requires you include a member ","type":"text"},{"code":"sessions","type":"codeVoice"},{"type":"text","text":". This is a "},{"isActive":true,"type":"reference","identifier":"doc:\/\/com.opticalaberration.hummingbird\/documentation\/HummingbirdAuth\/SessionContext"},{"text":" type which holds the session data for the current request and includes a generic parameter defining what type this session data is.","type":"text"}]},{"syntax":"swift","type":"codeListing","code":["struct MyRequestContext: SessionRequestContext {","    \/\/\/ core context","    public var coreContext: CoreRequestContextStorage","    \/\/\/ session context with UUID as the session object","    public let sessions: SessionContext<UUID>","}"]},{"text":"Saving a session","anchor":"Saving-a-session","type":"heading","level":2},{"type":"paragraph","inlineContent":[{"type":"text","text":"Once a user is authenticated you need to save a session for the user."}]},{"type":"codeListing","code":["func login(_ request: Request, context: MyRequestContext) async throws -> HTTPResponseStatus {","    \/\/ get authenticated user","    let user = try context.requireIdentity()","    \/\/ create session lasting 1 hour","    context.sessions.setSession(user.id, expiresIn: .seconds(600))","    return .ok","}"],"syntax":"swift"},{"inlineContent":[{"text":"In this example ","type":"text"},{"type":"codeVoice","code":"user.id"},{"text":" is saved with the session id. The data we save in ","type":"text"},{"type":"codeVoice","code":"setSession"},{"type":"text","text":" is saved to storage when we return to the "},{"code":"SessionMiddleware","type":"codeVoice"},{"type":"text","text":". If your route throws an error then the session data is not updated."}],"type":"paragraph"},{"level":2,"type":"heading","anchor":"Sessions-Authentication","text":"Sessions Authentication"},{"type":"paragraph","inlineContent":[{"type":"text","text":"To authenticate a user using a session id you need to add a "},{"identifier":"doc:\/\/com.opticalaberration.hummingbird\/documentation\/HummingbirdAuth\/SessionAuthenticator","isActive":true,"type":"reference"},{"text":" middleware to the router. This uses the session stored in the request context and converts it into the authenticated user using the closure or ","type":"text"},{"isActive":true,"type":"reference","identifier":"doc:\/\/com.opticalaberration.hummingbird\/documentation\/HummingbirdAuth\/UserSessionRepository"},{"text":" provided. The session authenticator requires your ","type":"text"},{"code":"RequestContext","type":"codeVoice"},{"text":" conforms to both ","type":"text"},{"type":"codeVoice","code":"SessionRequestContext"},{"text":" and ","type":"text"},{"code":"AuthRequestContext","type":"codeVoice"},{"text":".","type":"text"}]},{"syntax":"swift","code":["router.addMiddleware {","    SessionMiddleware(storage: MemoryPersistDriver())","    SessionAuthenticator { session, context in","        try await getUser(from: session)","    }","}","router.get(\"session\") { request, context -> HTTPResponse.Status in","    _ = try context.requireIdentity()","    return .ok","}"],"type":"codeListing"}],"kind":"content"}],"sections":[],"identifier":{"url":"doc:\/\/com.opticalaberration.hummingbird\/documentation\/Hummingbird\/Sessions","interfaceLanguage":"swift"},"references":{"doc://com.opticalaberration.hummingbird/documentation/HummingbirdAuth/SessionRequestContext":{"fragments":[{"text":"protocol","kind":"keyword"},{"kind":"text","text":" "},{"text":"SessionRequestContext","kind":"identifier"}],"abstract":[{"type":"text","text":"Protocol for RequestContext that stores session data"}],"kind":"symbol","url":"\/documentation\/hummingbirdauth\/sessionrequestcontext","role":"symbol","type":"topic","identifier":"doc:\/\/com.opticalaberration.hummingbird\/documentation\/HummingbirdAuth\/SessionRequestContext","title":"SessionRequestContext","navigatorTitle":[{"kind":"identifier","text":"SessionRequestContext"}]},"doc://com.opticalaberration.hummingbird/documentation/index":{"type":"topic","abstract":[{"text":"Documentation for Hummingbird the lightweight, flexible, modern server framework.","type":"text"}],"role":"collection","identifier":"doc:\/\/com.opticalaberration.hummingbird\/documentation\/index","url":"\/documentation\/index","kind":"article","images":[{"identifier":"logo.png","type":"icon"}],"title":"Hummingbird Documentation"},"logo.png":{"alt":null,"variants":[{"url":"\/images\/com.opticalaberration.hummingbird\/logo.png","traits":["1x","light"]}],"type":"image","identifier":"logo.png"},"doc://com.opticalaberration.hummingbird/documentation/HummingbirdAuth/SessionRequestContext/sessions":{"type":"topic","fragments":[{"text":"var","kind":"keyword"},{"text":" ","kind":"text"},{"kind":"identifier","text":"sessions"},{"kind":"text","text":": "},{"text":"SessionContext","kind":"typeIdentifier","preciseIdentifier":"s:15HummingbirdAuth14SessionContextV"},{"kind":"text","text":"<"},{"text":"Session","kind":"typeIdentifier","preciseIdentifier":"s:15HummingbirdAuth21SessionRequestContextP0C0Qa"},{"kind":"text","text":">"}],"identifier":"doc:\/\/com.opticalaberration.hummingbird\/documentation\/HummingbirdAuth\/SessionRequestContext\/sessions","kind":"symbol","role":"symbol","title":"sessions","required":true,"url":"\/documentation\/hummingbirdauth\/sessionrequestcontext\/sessions","abstract":[]},"doc://com.opticalaberration.hummingbird/documentation/Hummingbird/PersistentData":{"identifier":"doc:\/\/com.opticalaberration.hummingbird\/documentation\/Hummingbird\/PersistentData","kind":"article","images":[{"type":"icon","identifier":"logo.png"}],"type":"topic","abstract":[{"text":"How to persist data between requests to your server.","type":"text"}],"role":"article","title":"Persistent data","url":"\/documentation\/hummingbird\/persistentdata"},"doc://com.opticalaberration.hummingbird/documentation/HummingbirdAuth/SessionContext":{"navigatorTitle":[{"text":"SessionContext","kind":"identifier"}],"title":"SessionContext","kind":"symbol","abstract":[{"text":"Session context","type":"text"}],"type":"topic","identifier":"doc:\/\/com.opticalaberration.hummingbird\/documentation\/HummingbirdAuth\/SessionContext","role":"symbol","fragments":[{"text":"struct","kind":"keyword"},{"text":" ","kind":"text"},{"kind":"identifier","text":"SessionContext"}],"url":"\/documentation\/hummingbirdauth\/sessioncontext"},"doc://com.opticalaberration.hummingbird/documentation/HummingbirdRedis/RedisPersistDriver":{"kind":"symbol","identifier":"doc:\/\/com.opticalaberration.hummingbird\/documentation\/HummingbirdRedis\/RedisPersistDriver","role":"symbol","navigatorTitle":[{"text":"RedisPersistDriver","kind":"identifier"}],"abstract":[{"type":"text","text":"Redis driver for persist system for storing persistent cross request key\/value pairs"}],"title":"RedisPersistDriver","type":"topic","url":"\/documentation\/hummingbirdredis\/redispersistdriver","fragments":[{"text":"struct","kind":"keyword"},{"text":" ","kind":"text"},{"kind":"identifier","text":"RedisPersistDriver"}]},"doc://com.opticalaberration.hummingbird/documentation/HummingbirdFluent/FluentPersistDriver":{"role":"symbol","abstract":[{"type":"text","text":"Fluent driver for persist system for storing persistent cross request key\/value pairs"}],"url":"\/documentation\/hummingbirdfluent\/fluentpersistdriver","type":"topic","fragments":[{"kind":"keyword","text":"class"},{"kind":"text","text":" "},{"kind":"identifier","text":"FluentPersistDriver"}],"kind":"symbol","title":"FluentPersistDriver","navigatorTitle":[{"text":"FluentPersistDriver","kind":"identifier"}],"identifier":"doc:\/\/com.opticalaberration.hummingbird\/documentation\/HummingbirdFluent\/FluentPersistDriver"},"doc://com.opticalaberration.hummingbird/documentation/HummingbirdAuth/SessionMiddleware":{"role":"symbol","title":"SessionMiddleware","abstract":[{"type":"text","text":"Middleware that extracts session data for a request and stores it in the context"}],"url":"\/documentation\/hummingbirdauth\/sessionmiddleware","identifier":"doc:\/\/com.opticalaberration.hummingbird\/documentation\/HummingbirdAuth\/SessionMiddleware","navigatorTitle":[{"text":"SessionMiddleware","kind":"identifier"}],"fragments":[{"kind":"keyword","text":"struct"},{"text":" ","kind":"text"},{"text":"SessionMiddleware","kind":"identifier"}],"kind":"symbol","type":"topic"},"doc://com.opticalaberration.hummingbird/documentation/HummingbirdAuth/SessionAuthenticator":{"title":"SessionAuthenticator","kind":"symbol","abstract":[{"text":"Session authenticator","type":"text"}],"fragments":[{"text":"struct","kind":"keyword"},{"text":" ","kind":"text"},{"text":"SessionAuthenticator","kind":"identifier"}],"type":"topic","url":"\/documentation\/hummingbirdauth\/sessionauthenticator","role":"symbol","navigatorTitle":[{"text":"SessionAuthenticator","kind":"identifier"}],"identifier":"doc:\/\/com.opticalaberration.hummingbird\/documentation\/HummingbirdAuth\/SessionAuthenticator"},"doc://com.opticalaberration.hummingbird/documentation/Hummingbird/AuthenticatorMiddlewareGuide":{"kind":"article","url":"\/documentation\/hummingbird\/authenticatormiddlewareguide","type":"topic","identifier":"doc:\/\/com.opticalaberration.hummingbird\/documentation\/Hummingbird\/AuthenticatorMiddlewareGuide","abstract":[{"type":"text","text":"Request authentication middleware"}],"title":"Authenticator Middleware","role":"article","images":[{"type":"icon","identifier":"logo.png"}]},"doc://com.opticalaberration.hummingbird/documentation/Hummingbird/OneTimePasswords":{"abstract":[{"type":"text","text":"A one time password (OTP) valid for only one login session."}],"identifier":"doc:\/\/com.opticalaberration.hummingbird\/documentation\/Hummingbird\/OneTimePasswords","kind":"article","type":"topic","title":"One Time Passwords","url":"\/documentation\/hummingbird\/onetimepasswords","role":"article","images":[{"type":"icon","identifier":"logo.png"}]},"doc://com.opticalaberration.hummingbird/documentation/HummingbirdAuth/UserSessionRepository":{"role":"symbol","type":"topic","identifier":"doc:\/\/com.opticalaberration.hummingbird\/documentation\/HummingbirdAuth\/UserSessionRepository","url":"\/documentation\/hummingbirdauth\/usersessionrepository","abstract":[{"type":"text","text":"Repository of users identified by a session object"}],"kind":"symbol","navigatorTitle":[{"text":"UserSessionRepository","kind":"identifier"}],"title":"UserSessionRepository","fragments":[{"kind":"keyword","text":"protocol"},{"text":" ","kind":"text"},{"text":"UserSessionRepository","kind":"identifier"}]}}}